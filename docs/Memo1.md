# `web-json-api` と `str-client` の連携利用ガイド

## 1. 概要

`piservo0` は、サーボモーターを制御するための2つの主要なインターフェースを提供します。

-   `web-json-api`: HTTP経由でJSON形式のコマンドを受け付けるWeb APIサーバー。サーボモーターを直接制御します。
-   `str-client`: 人間が読みやすい文字列形式のコマンドを、`web-json-api` が解釈できるJSON形式に変換して送信するコマンドラインクライアント。

これらはクライアント・サーバーモデルとして設計されており、連携して使用します。まず`web-json-api`サーバーを起動し、次に`str-client`からそのサーバーに接続してサーボを操作します。

## 2. 利用手順

### ステップ1: Web API サーバーの起動

まず、サーボを制御するWeb APIサーバーを起動します。

1.  ターミナルを開き、制御したいサーボが接続されているGPIOピン番号を指定して、以下のコマンドを実行します。ピンの指定順がサーボのID（0から始まる）に対応します。

    ```bash
    # 例: GPIO 17 をサーボ0, GPIO 27 をサーボ1として制御する場合
    uv run piservo0 web-json-api 17 27
    ```

2.  サーバーが起動し、デフォルトでは `http://0.0.0.0:8000` でリクエストを待ち受けます。このターミナルはサーバーが動作し続けるため、開いたままにしておきます。

    ```
    INFO:     Started server process [xxxxx]
    INFO:     Waiting for application startup.
    INFO:     Application startup complete.
    INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
    ```

### ステップ2: 文字列コマンドクライアントの起動と操作

次に、別のターミナルを開いて、`str-client` を起動し、サーバーにコマンドを送信します。

1.  新しいターミナルを開きます。

2.  以下のコマンドを実行して、クライアントを対話モードで起動します。

    ```bash
    uv run piservo0 str-client
    ```
    
    -   もし `web-json-api` サーバーをデフォルト以外のホストやポートで起動した場合は、`--url` オプションで指定します。
        ```bash
        uv run piservo0 str-client --url http://<your-server-ip>:<port>/cmd
        ```
    -   サーボの回転方向を個別に反転させたい場合は `--angle_factor` を使います。例えば、サーボ1の角度の符号を反転させるには `1,-1` を指定します。
        ```bash
        uv run piservo0 str-client --angle_factor 1,-1
        ```

3.  クライアントが起動すると、プロンプト `str-client> ` が表示されます。ここに文字列形式のコマンドを入力してサーボを操作できます。

    **コマンド例:**

    -   サーボ0を30度、サーボ1を90度に動かす:
        ```
        str-client> mv:30,90
        ```

    -   サーボ0は-45度、サーボ1は動かさない:
        ```
        str-client> mv:-45,.
        ```

    -   サーボ0を最大角(max)、サーボ1を中央(center)に動かす:
        ```
        str-client> mv:x,c
        ```

    -   1.5秒待機する:
        ```
        str-client> sl:1.5
        ```
    
    -   対話モードを終了するには `exit` または `quit` と入力するか、`Ctrl+D` を押します。

### ステップ3: サーバーの停止

操作が終わったら、`web-json-api`サーバーを停止します。サーバーが動作しているターミナルで `Ctrl+C` を押してください。

## 3. コマンドリファレンス (`str-client`)

コマンドは `コマンドキー:パラメータ` の形式で入力します。

| コマンドキー | パラメータ | 説明 |
| :--- | :--- | :--- |
| `mv` | `angles` | サーボを指定角度に同期して動かします。パラメータはカンマ区切りで、各サーボの角度を数値 (`-90`～`90`)、`.` (不動)、`x`(max)、`n`(min)、`c`(center)で指定します。 |
| `sl` | `sec` | 指定時間（秒）だけ待機します。 |
| `ms` | `sec` | 指定時間（秒）をかけて、現在のポーズから次のポーズへ移動します。 |
| `st` | `n` | ポーズリストを `n` ステップ進めます。 |
| `is` | `sec` | `st` コマンド実行時の各ステップ間のインターバル（秒）を設定します。 |
| `ca`, `zz` | なし | 現在実行中の動作をキャンセルします。 |