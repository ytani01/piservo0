# String to JSON API Client (`str-client`) リファレンス

このドキュメントは、コマンドラインツール `piservo0 str-client` の使い方について説明します。

## 概要

`str-client`は、手軽な**短縮文字列コマンド**（例: `mv:c,c,c,c`）を、高機能な**JSONコマンド**に内部で変換し、`web-json-api`サーバーへ送信するためのクライアントツールです。

これにより、開発者はJSONを直接記述することなく、ターミナルから簡単なコマンドで、ネットワーク経由の高度なサーボ制御ができます。

## 前提条件

このツールを使用する前に、制御対象のRaspberry Pi上で **`web-json-api`** サーバーが起動している必要があります。

**サーバーの起動例:**
```bash
# Raspberry Pi上で、GPIOピン 18, 23, 24, 25 を使ってサーバーを起動
uv run piservo0 web-json-api 18 23 24 25
```
**注意:** `web-str-api` サーバーではない点に注意してください。

## 書式

```bash
uv run piservo0 str-client [OPTIONS] [CMDLINE]...
```

- `[OPTIONS]`: `--url` などのオプションを指定します。
- `[CMDLINE]...`: 実行したい短縮文字列コマンドをスペース区切りで指定します。省略した場合は、対話モードで起動します。

---

## 使い方

### 1. 単一コマンドの実行

引数に実行したいコマンドを一つ指定します。クライアントはこれをJSONに変換し、サーバーに送信します。

**例:** 4つのサーボをすべて中央に移動させる
```bash
uv run piservo0 str-client 'mv:c,c,c,c'
```
> **内部の動き:**
> 1. `'mv:c,c,c,c'` を `{"cmd": "move_angle_sync", "target_angles": ["center", "center", "center", "center"]}` に変換します。
> 2.  このJSONを `web-json-api` サーバーの `/cmd` エンドポイントにPOSTします。

### 2. 複数コマンドの実行

引数に実行したいコマンドをスペースで区切って複数指定します。各コマンドが順にJSONに変換され、サーバーに送信されます。

**例:** サーボを90度に動かし、1秒待ってから-90度に動かす
```bash
uv run piservo0 str-client 'mv:90,90,90,90' 'sl:1' 'mv:-90,-90,-90,-90'
```

### 3. 対話モード

引数を何も指定せずに実行すると、対話モードになります。プロンプト（`>`）が表示され、コマンドを一つずつ入力・実行できます。

- コマンド履歴が `~/.piservo0_apiclient_history` に保存され、上下キーで履歴を呼び出せます。
- `exit` または `quit` と入力するか、`Ctrl-D` を押すと終了します。

**起動方法:**
```bash
uv run piservo0 str-client
```

**対話モードでの操作例:**
```
> mv:0,0,0,0
> sl:0.5
> mv:45,-45,45,-45
> exit
Bye!
```

---

## オプション

#### `-u, --url TEXT`

接続先の `web-json-api` サーバーのURLを指定します。

- **デフォルト:** `http://localhost:8000/cmd`
- **例:** IPアドレス `192.168.1.10` のRaspberry Piに接続する場合
  ```bash
  uv run piservo0 str-client -u http://192.168.1.10:8000/cmd 'mv:c,c,c,c'
  ```

#### `--history_file TEXT`

対話モードで使われるコマンド履歴ファイルのパスを指定します。

- **デフォルト:** `~/.piservo0_apiclient_history`

#### `-a, --angle_factor TEXT`

**クライアント側で**文字列コマンドをJSONに変換する際に、各サーボの角度の符号を反転させるための係数をカンマ区切りで指定します。`1` または `-1` を使用します。

これは、サーボの取り付け向きによって回転方向をプログラム側で吸収したい場合に便利です。

- **デフォルト:** `1,1,1,1`
- **例:** 2番目と4番目のサーボの回転方向を反転させる
  ```bash
  uv run piservo0 str-client -a 1,-1,1,-1 'mv:45,45,45,45'
  ```
  > **内部の動き:**
  > 1. `angle_factor` `[1, -1, 1, -1]` を適用して、`'mv:45,45,45,45'` を `{"cmd": "move_angle_sync", "target_angles": [45, -45, 45, -45]}` に変換します。
  > 2. このJSONをサーバーに送信します。

#### `-d, --debug`

デバッグログを有効にします。変換後のJSONや通信内容などの詳細情報が表示され、問題解決に役立ちます。

#### `-h, --help`

ヘルプメッセージを表示します。
