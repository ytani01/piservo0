# 文字列コマンドによるサーボ制御

`piservo0.helper.str_control.StrControl`クラスは、文字列ベースのコマンドを解釈し、複数のサーボモーターを制御する。これにより、ロボットの歩行などの複雑な動作を簡単に実現できる。

## 概要

`StrControl`クラスは、`MultiServo`または`ThreadMultiServo`オブジェクトをラップし、以下のような文字列コマンドを通じてサーボのポーズ（姿勢）や動作を制御する。

*   **ポーズコマンド**: 各サーボの目標角度を文字で表現する。例えば、`fbcb`は4つのサーボのポーズを定義する。
*   **スリープコマンド**: 指定した秒数だけ処理を一時停止する。
*   **キャンセルコマンド**: `ThreadMultiServo`を使用している場合に、実行中のコマンドシーケンスをキャンセルする。

## `strctrl`コマンドラインツールでの利用

`piservo0`は、文字列コマンドを直接コマンドラインから実行するための`strctrl`コマンドを提供する。これは、サーボが接続されているRaspberry Piなどのデバイス上で直接サーボを制御する場合に便利である。

### 使い方

`strctrl`コマンドは、引数としてGPIOピンのリストを受け取り、その後に対話モードに入る。対話モードでは、プロンプトが表示され、文字列コマンドを入力して実行できる。

```bash
uv run piservo0 strctrl 17 27 22 25
```

上記のコマンドを実行すると、GPIOピン17, 27, 22, 25に接続されたサーボを制御するための対話モードが開始される。

プロンプトが表示されたら、コマンドを入力してEnterキーを押す。`Ctrl-C`または`Ctrl-D`で終了する。

**対話モードでの操作例:**

```
* history file: /home/user/.piservo0_strctrl_history
* Ctrl-C (Interrput) or Ctrl-D (EOF) for quit
> fbcb
> 0.5
> bcfb 0.5 fbcb
> z
> .
> ^C
* Bye
```

### オプション

`strctrl`コマンドには、以下のオプションがある。

*   `--conf_file` (`-c`): サーボ設定ファイルのパス（デフォルト: `CalibrableServo.DEF_CONF_FILE`）。
*   `--move_sec` (`-m`): 1ポーズの移動にかける時間（秒）（デフォルト: `0.2`）。
*   `--step_n` (`-s`): サーボ移動のステップ数（デフォルト: `MultiServo.DEF_STEP_N`）。
*   `--angle_unit` (`-u`): `f`（前方）および`b`（後方）コマンドの基本角度（デフォルト: `35.0`）。
*   `--angle_factor` (`-f`): 各サーボの角度に掛ける係数のリスト。スペース区切りで指定する（例: `"-1 -1 1 1"`）（デフォルト: `"-1 -1 1 1"`）。
*   `--debug` (`-d`): デバッグログを有効にするか。

**例:**

基本角度を40度、移動時間を0.3秒に設定して`strctrl`を起動する。

```bash
uv run piservo0 strctrl 17 27 22 25 --angle-unit 40.0 --move_sec 0.3
```

## コマンドの種類とフォーマット

### 1. ポーズコマンド

各サーボの目標角度を1文字で表現する。コマンド文字列の長さは、制御対象のサーボの数と一致する必要がある。

**デフォルトのコマンド文字:**

| 文字 | 意味                               | 角度（`angle_unit`が35.0の場合） |
| :--- | :--------------------------------- | :------------------------------- |
| `c`  | センター（Center）                 | 0度                              |
| `n`  | 最小角度（Min）                    | サーボの最小可動範囲             |
| `x`  | 最大角度（Max）                    | サーボの最大可動範囲             |
| `f`  | 前方（Forward）                    | `angle_unit`で指定された角度     |
| `b`  | 後方（Backward）                   | `-angle_unit`で指定された角度    |
| `.`  | 動かさない（Don't Move）           | 現在の角度を維持                 |
| `z`  | コマンドキャンセル（Cancel Cmds）  | `ThreadMultiServo`の場合のみ有効 |

**大文字と小文字:**

コマンド文字を大文字にすると、そのサーボの角度が2倍になる。
例: `F` は `f` の2倍の角度になる。

### 2. スリープコマンド

数値文字列はスリープ時間（秒）として解釈される。

例: `0.5` は0.5秒間待機する。

### 3. キャンセルコマンド

`z`文字がコマンド文字列に含まれている場合、`ThreadMultiServo`を使用している場合に限り、現在実行中のコマンドシーケンスをキャンセルする。

例: `z` または `fczb` のように、`z`が含まれていればキャンセルコマンドとして認識される。

## 設定オプション

`StrControl`のコンストラクタでは、以下のオプションを設定できる。（これは`strctrl`コマンドのオプションと対応している）

*   `mservo` (`MultiServo | ThreadMultiServo`): 制御対象の`MultiServo`または`ThreadMultiServo`インスタンス。必須。
*   `move_sec` (`float`, デフォルト: `0.2`): 1ポーズの移動にかける時間（秒）。
*   `step_n` (`int`, デフォルト: `MultiServo.DEF_STEP_N`): サーボ移動のステップ数。
*   `angle_unit` (`float`, デフォルト: `35.0`): `f`（前方）および`b`（後方）コマンドの基本角度。
*   `angle_factor` (`list[int] | None`, デフォルト: `[-1, -1, 1, 1]`): 各サーボの角度に掛ける係数のリスト。サーボの回転方向を反転させるのに使用する。リストの長さはサーボの数と一致する必要がある。
*   `cmd_chars` (`dict[str, str] | None`, デフォルト: `StrControl.DEF_CMD_CHARS`): ポーズを定義する文字をカスタムする場合に指定する辞書。
*   `debug` (`bool`, デフォルト: `False`): デバッグログを有効にするか。

### メソッドによる設定変更

インスタンス作成後も、以下のメソッドで設定を変更できる。

*   `set_angle_unit(angle: float)`: 基本角度を設定する。
*   `set_move_sec(sec: float)`: 移動時間を設定する。