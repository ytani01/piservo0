# 自動テスト作成のポイント

このディレクトリには、`piservo0` プロジェクトの自動テストが格納されています。
ここでは、これらのテストを参考に、自動テストを作成する際の主要なポイントをまとめます。

## 1. テストフレームワークの選定と活用

### `pytest` の利用
このプロジェクトでは、Pythonの強力なテストフレームワークである `pytest` を使用しています。`pytest` は、テストの発見、実行、レポート作成を容易にし、シンプルながらも高度なテストを記述できます。

### フィクスチャ (`@pytest.fixture`)
テストのセットアップ（初期化）とティアダウン（クリーンアップ）を共通化するために使用します。
- `scope="function"` を指定することで、各テスト関数の実行ごとにフィクスチャが実行され、テスト間の独立性を保ちます。
- `yield` を使うことで、テスト実行前後の処理を記述できます。
- **例**: `servo_test_setup`, `calib_servo_setup`, `calib_app_setup` は、`pigpio` のインスタンスやサーボオブ��ェクトの初期化、テスト後の停止・ファイル削除などを一元的に行っています。

### パラメタライズドテスト (`@pytest.mark.parametrize`)
同じテストロジックで複数の異なる入力値と期待値をテストする場合に非常に有効です。
- テストコードの重複を減らし、可読性を高めます。
- **例**: `test_01_piservo.py` の `test_move_pulse` で、様々なパルス幅と期待値を一度にテストしています。

## 2. テストの粒度と独立性

### 単一責任の原則
各テスト関数は、特定の機能や振る舞いのみをテストするようにします。これにより、テストが失敗した際に問題の原因を特定しやすくなります。

### 独立性
各テストは他のテストに依存しないようにします。フィクスチャを使ってテスト環境を毎回クリーンにすることで、テストの実行順序に左右されない信頼性の高いテストになります。

## 3. アサーション (`assert`)

テスト対象のコードが期待通りの結果を返すかを確認するために `assert` ステートメントを使用します。
- 数値の比較には `pytest.approx` を使用し、浮動小数点数の誤差を許容するようにします。
- ファイルの存在確認 (`os.path.exists`) や、JSONファイルの内容確認 (`json.load`) など、様々なアサーションを適切に使い分けます。

## 4. テスト対象の分離とモック (`pytest-mock`)

外部依存（例: `pigpio` デーモン、ファイルシステム）がある場合、それらを直接操作せずにテストするためにモックを使用することを検討します。
- `pytest-mock` ライブラリの `mocker` フィクスチャを使うと、オブジェクトのメソッドや属性を一時的に置き換えることができます。
- **例**: `test_03_multi_servo.py` の `test_move_angle_invalid_length` や `test_move_angle_invalid_type` では、ロガーのエラーメソッドをモック化して、エラーが正しく呼び出されたことを確認しています。これにより、実際のログ出力に影響を与えずにテストできます。

## 5. テストデータの管理

テストに必要な設定ファイル（例: `test_servo_tool_conf.json`）は、テストのセットアップ時に作成し、ティアダウン時に削除することで、テスト環境をクリーンに保ちます。
- テストデータは、テストコード内に直接記述するか、小さなJSONファイルなどで管理します。

## 6. 現実世界とのインタラクションの考慮

サーボモーターのように物理的な動きを伴う場合、`time.sleep()` を適切に挿入して、動作が完了するのを待つ必要があります。ただし、テスト時間を不必要に長くしないよう、最小限の時間に留めます。
- `pigpio` デーモンへの接続確認 (`pi.connected`) のように、外部システムの状態を確認するロジックも重要です。

## 7. テストの命名規則

- `test_` で始まる関数名やファイル名は `pytest` によって自動的にテストとして認識されます。
- テスト関数名は、テストする機能や振る舞いを明確に表すようにします（例: `test_move_center`, `test_set_calibration_and_save`）。

## 8. コメントとドキュメンテーション

各テスト関数やフィクスチャには、その目的やテスト内容を簡潔に説明するDocstringを記述します。これにより、テストコードの意図が明確になり、メンテナンス性が向上します。

---
これらのポイントを参考に、新しい機能を追加する際や既存のコードを修正する際に、適切な自動テストを作成してください。
